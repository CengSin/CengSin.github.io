<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>CengSin PERSONAL BLOG | Go语言实现的APNs推送服务：一次稳定性问题的排查与优化实录</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.153.5"><meta name=ROBOTS content="INDEX, FOLLOW"><link href=/dist/app.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css integrity=sha384-zh0CIslj+VczCZtlzBcjt5ppRcsAmDnRem7ESsYwWwg3m/OaJ2l4x7YBZl9Kxxib crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js integrity=sha384-Rma6DA2IPUwhNxmrB/7S3Tno0YY7sFu9WSYMCuulLhIqYSGZ2gKCJWIqhBWqMQfh crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js integrity=sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><script>(function(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(e)}),i.parentNode.insertBefore(n,i)})("/lib/pangu.min.js",function(){pangu.spacingPage()})</script><style type=text/css media="screen, print">@font-face{font-family:fancytitlefont;font-style:normal;font-display:swap;src:url(%25!s%28%3cnil%3e%29.woff2)format('woff2'),url(%25!s%28%3cnil%3e%29.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:300;font-display:swap;src:local('Noto Serif CJK SC Light'),local('NotoSerifCJK-Light'),url(/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff2)format('woff2'),url(/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:400;font-display:swap;src:local('Noto Serif CJK SC'),local('NotoSerifCJK-Regular'),url(/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff2)format('woff2'),url(/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:500;font-display:swap;src:local('Noto Serif CJK SC Medium'),local('NotoSerifCJK-Medium'),url(/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff2)format('woff2'),url(/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff)format('woff')}</style></head><body class="bg-gray-100 text-gray-700 font-sans"><div class="p-6 sm:p-10 md:p-16 flex flex-wrap"><header class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-1 md:order-1 max-w-2xl"><div class="z-50 bg-gray-100 bg-opacity-75 bg-opacity-custom lg:min-w-0.7 max-w-xl md:float-right md:text-right leading-loose tracking-tight md:sticky md:top-0 pt-2"><div><h2><a href=/ title="CengSin PERSONAL BLOG" class="heading font-cursive icon">CengSin PERSONAL BLOG</a></h2></div><h1 class=pt-2>Go语言实现的APNs推送服务：一次稳定性问题的排查与优化实录</h1><div class="flex flex-wrap justify-end pt-2"><div class="md:flex-grow-0 font-light"></div><time class="text-eucalyptus-500 md:text-right md:flex-grow font-light pl-4" datetime=2025-06-27T14:26:00+08:00>2025-6-27 14:26</time></div><hr></div></header><main role=main class="w-full md:w-3/5 xl:w-1/2 max-w-3xl order-2 md:order-2 min-h-70vh pt-2 pb-4"><article><section class="mx-auto content"><div class=c-rich-text><h1 id=go语言实现的apns推送服务一次稳定性问题的排查与优化实录>Go语言实现的APNs推送服务：一次稳定性问题的排查与优化实录</h1><p>在生产环境中部署 APNs 推送服务时，我们遇到了一个让人头疼的问题：<strong>服务运行约一周后，会突然停止推送消息</strong>，且腾讯云实例的内存占用达到 100%。本文将详细记录从最初的异常现象，到最后稳定运行的整个排查与优化过程，希望对你构建稳定、高效的 Go 推送服务有所帮助。</p><hr><h2 id=异步问题>异步问题</h2><p>生产环境下，程序运行约一周后推送功能会失效。梳理相关代码流程如下：</p><p>生产者将消息放入队列A，Consumer-A消费后同步将响应写入队列B。Consumer-B同步消费队列B，将推送结果写入缓存，随后通过定时任务批量保存到数据库。</p><p>问题出在队列B：高峰期Consumer-B消费速度慢于Consumer-A，导致队列B被填满。此时，推送响应阻塞在写入队列B的操作上，程序不断创建新的goroutine，最终内存耗尽导致服务崩溃。</p><h3 id=优化>优化</h3><p>简化代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 优化塞入消费队列B的操作</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>channelB</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>data</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>After</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这样，当channelB已满时，1秒超时后直接丢弃响应，避免Consumer-A因阻塞而无限制创建goroutine。</p><h2 id=一问题现象与初步排查>一、问题现象与初步排查</h2><ul><li><strong>初始配置</strong>：服务启动时会根据配置创建 <code>200 个 httpClient</code>，每个 client 启动 <code>400 个 goroutine</code>，总计约 <strong>8 万个 goroutine</strong>。</li><li><strong>问题表现</strong>：服务运行一周左右后 <strong>完全停止推送</strong>，同时腾讯云实例内存占用达到 <strong>100%</strong>。</li><li><strong>第一步尝试</strong>：简单地提升云主机内存，但问题并未解决，<strong>仅仅延后了推送停滞的时间</strong>。</li></ul><hr><h2 id=二深入阅读源码找出并发模型的问题>二、深入阅读源码，找出并发模型的问题</h2><ul><li>阅读代码后发现，每个 HTTP client 会配套启动 goroutine 队列，导致 goroutine 数量极度膨胀。</li><li>初步怀疑 goroutine 与连接数的组合导致了内存膨胀与资源抢占。</li></ul><h3 id=-动作调整配置>🔧 动作：调整配置</h3><ul><li>将配置修改为：<code>10 个 httpClient</code>，每个 client 启动 <code>100 个 goroutine</code>。</li><li><strong>效果</strong>：内存占用明显降低，但 <strong>推送停止问题依然存在</strong>，只是<strong>发生时间变长了</strong>。</li></ul><hr><h2 id=三提高日志等级捕获-apns-的-goaway-信号>三、提高日志等级，捕获 APNs 的 GOAWAY 信号</h2><ul><li>将日志级别调为 <code>Error</code>，观察关键错误。</li><li>发现日志中频繁出现：<code>http2: received GOAWAY</code> 的错误。</li></ul><h3 id=-理解-goaway>🧠 理解 GOAWAY：</h3><ul><li>GOAWAY 是 HTTP/2 协议中服务端通知关闭连接的帧。</li><li>APNs 服务器可能因<strong>连接使用过度</strong>或<strong>资源占用过多</strong>而主动断开。</li></ul><hr><h2 id=四实现连接重建逻辑>四、实现连接重建逻辑</h2><h3 id=-初步方案>🛠 初步方案：</h3><ul><li>在捕获到 <code>http2.GoAwayError</code> 时，调用 <code>replaceTransport()</code> 逻辑，重建 HTTP 客户端连接。</li></ul><h3 id=-遇到问题>🐞 遇到问题：</h3><ul><li>日志中发现：<code>interface conversion: error is *errors.errorString, not http2.GoAwayError</code></li><li>原因是代码错误地将 <code>error</code> 类型直接断言为 <code>http2.GoAwayError</code>，导致 panic。</li></ul><h3 id=-修复方式>✅ 修复方式：</h3><p>使用 <code>errors.As()</code> 安全判断底层错误类型：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>goAwayErr</span> <span style=color:#a6e22e>http2</span>.<span style=color:#a6e22e>GoAwayError</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>As</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Err</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>goAwayErr</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 正确捕获 GOAWAY 错误</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>replaceHttpClient</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=-发布后验证>🟢 发布后验证：</h3><ul><li>日志中确认 <code>replaceTransport()</code> 被触发。</li><li>GOAWAY 后能自动重连，服务持续运行未中断。</li></ul><hr><h2 id=五当前配置与运行状态>五、当前配置与运行状态</h2><ul><li><strong>httpClient 数量</strong>：50</li><li><strong>每个 Client goroutine 数量</strong>：200</li><li><strong>状态</strong>：服务稳定运行，内存占用合理，GOAWAY 可自愈处理。</li></ul><hr><h2 id=六后续优化建议>六、后续优化建议</h2><table><thead><tr><th>优化方向</th><th>建议</th><th>目的</th></tr></thead><tbody><tr><td>连接池管理</td><td>- 统一使用 <code>http.Transport</code>，设置 <code>MaxIdleConnsPerHost</code> 充足- 避免每个 client 自建 Transport</td><td>提升连接复用率，减少建连开销</td></tr><tr><td>并发动态调整</td><td>- 监控 GOAWAY、重试次数- 高负载时自动降并发</td><td>降低 APNs 断连接概率</td></tr><tr><td>内存与 GC 监控</td><td>- 启用 <code>pprof</code>- 定期抓取堆快照</td><td>及时发现 goroutine 或对象泄漏</td></tr><tr><td>错误分类重试</td><td>- 区分 GOAWAY / 网络失败 / 非重试错误</td><td>提高重试成功率、减少资源浪费</td></tr><tr><td>指标监控告警</td><td>- 集成 Prometheus/Grafana- 监控连接数、错误率、推送成功率等</td><td>快速发现问题趋势，防患未然</td></tr></tbody></table><hr><h2 id=七小结>七、小结</h2><p>通过本次稳定性问题的排查，你已经：</p><ul><li>识别出 goroutine 与内存暴涨之间的因果关系；</li><li>正确理解并处理了 HTTP/2 的 GOAWAY 机制；</li><li>用日志 + 错误类型匹配的方式，实现了连接重建的自愈逻辑；</li></ul><blockquote><p>稳定的系统不是不出错，而是能<strong>及时感知和快速恢复</strong>。这次经历非常有代表性，也为你构建更健壮的推送服务打下了基础。</p></blockquote><hr><p>如果你有类似服务，也欢迎参考这份经验流程，或与我交流进一步的系统设计和优化策略。</p></div></section></article></main><div class="w-full h-0 flex-none order-3"></div><aside role=contentinfo class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-4 md:order-3 md:sticky md:bottom-0 self-end max-w-2xl"><div class="md:float-right md:text-right leading-loose tracking-tight md:mb-2"><div class="md:max-w-xs flex flex-col md:items-end"><ul class="font-serif flex-grow-0 flex justify-between flex-wrap md:flex-col"><li class="px-1 md:px-0"><a href=/posts/ title="文章 page" class="font-medium text-medium-red-violet-600 hover:text-medium-red-violet-400">文章</a></li><li class="px-1 md:px-0"><a href=/tags/ title="标签 page">标签</a></li></ul><div class="text-sm text-gray-500 leading-tight a-gray"><br>Built with Hugo and theme <a href=https://github.com/heyeshuang/hugo-theme-tokiwa>Tokiwa</a>. 210 words in this page.</div></div></div></aside><footer class="w-full md:w-3/5 xl:w-1/2 order-3 max-w-3xl md:order-4 pt-2"><hr class=double-line><div class="flex flex-wrap justify-between pb-2 leading-loose font-serif"><a class=flex-grow-0 href=/posts/number_of_boomerangs/><svg class="fill-current inline-block h-4 w-4" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7.828 11H20v2H7.828l5.364 5.364-1.414 1.414L4 12l7.778-7.778 1.414 1.414z"/></svg>
回旋镖的数量
</a><a class=flex-grow-0 href=/posts/%E4%BB%8E%E5%B0%8F%E7%B1%B3yu7%E7%88%86%E7%81%AB%E7%9C%8B%E5%A6%82%E4%BB%8A%E5%9B%BD%E5%86%85%E7%9A%84%E5%93%81%E7%89%8C%E7%8E%B0%E7%8A%B6/>从小米YU7爆火看如今国内的品牌现状
<svg class="fill-current inline-block h-4 w-4" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z"/></svg></a></div><div></div><hr><div class=pb-2></div><hr></footer><script src=/dist/app.js></script></div></body></html>